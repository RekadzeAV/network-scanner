# Архитектура проекта - Network Scanner

## Содержание

1. [Обзор архитектуры](#обзор-архитектуры)
2. [Диаграмма компонентов](#диаграмма-компонентов)
3. [Поток данных](#поток-данных)
4. [Параллелизм и синхронизация](#параллелизм-и-синхронизация)
5. [Обработка ошибок](#обработка-ошибок)
6. [Расширяемость](#расширяемость)

---

## Обзор архитектуры

Network Scanner использует **модульную архитектуру** с четким разделением ответственности между компонентами.

### Архитектурные принципы

1. **Разделение ответственности (SoC):**
   - Каждый модуль отвечает за свою область
   - Минимальные зависимости между модулями

2. **Конкурентность:**
   - Использование горутин Go для параллельной работы
   - Управление ресурсами через семафоры

3. **Расширяемость:**
   - Легко добавлять новые функции
   - Модульная структура позволяет заменять компоненты

4. **Кроссплатформенность:**
   - Абстракция от системных вызовов
   - Использование стандартной библиотеки Go

---

## Диаграмма компонентов

### CLI приложение

```
┌─────────────────────────────────────────────────────────────┐
│              cmd/network-scanner/main.go                     │
│  - Парсинг параметров командной строки                      │
│  - Инициализация сканера                                     │
│  - Обработка сигналов                                        │
│  - Координация работы                                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              internal/scanner/scanner.go                     │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          NetworkScanner                               │   │
│  │  - Управление процессом сканирования                 │   │
│  │  - Обнаружение активных хостов                        │   │
│  │  - Сканирование портов                                │   │
│  │  - Получение MAC адресов                              │   │
│  │  - Определение типов устройств                        │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          ScanResult                                    │   │
│  │  - IP, MAC, Hostname                                   │   │
│  │  - Порты, Протоколы                                    │   │
│  │  - Тип устройства, Производитель                       │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────┬───────────────────────────┬──────────────────┘
               │                           │
               ▼                           ▼
┌──────────────────────────┐  ┌──────────────────────────────┐
│  internal/network/       │  │  internal/display/           │
│      network.go          │  │      display.go              │
│  - Определение сети      │  │  - Форматирование результатов│
│  - Парсинг диапазонов    │  │  - Генерация аналитики      │
│  - Проверка портов        │  │  - Статистика                │
│  - Определение сервисов  │  │  - Вывод таблиц              │
└──────────────────────────┘  └──────────────────────────────┘
```

### GUI приложение

```
┌─────────────────────────────────────────────────────────────┐
│                    cmd/gui/main.go                           │
│  - Точка входа GUI приложения                               │
│  - Инициализация GUI                                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              internal/gui/app.go                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                  App (GUI Application)                │   │
│  │  - Управление окном приложения                        │   │
│  │  - Инициализация UI компонентов                       │   │
│  │  - Обработка событий пользователя                     │   │
│  │  - Запуск сканирования                                │   │
│  │  - Сохранение результатов                             │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────┬───────────────────────────┬──────────────────┘
               │                           │
               ▼                           ▼
┌──────────────────────────┐  ┌──────────────────────────────┐
│  internal/gui/           │  │  internal/scanner/           │
│      formatter.go        │  │      scanner.go              │
│  - Форматирование        │  │  - Логика сканирования       │
│    результатов для GUI   │  │  - NetworkScanner            │
│  - Markdown форматирование│  │                              │
└──────────────────────────┘  └──────────────────────────────┘
```

---

## Поток данных

### Основной поток выполнения

```
1. Запуск приложения (main.go)
   │
   ├─► Парсинг параметров командной строки
   │
   ├─► Определение сети (network.go::detectLocalNetwork)
   │   └─► Если не указана, автоматическое определение
   │
   ├─► Создание NetworkScanner (scanner.go::NewNetworkScanner)
   │
   ├─► Запуск сканирования (scanner.go::Scan)
   │   │
   │   ├─► Парсинг диапазона сети (network.go::parseNetworkRange)
   │   │   └─► Генерация списка IP адресов
   │   │
   │   ├─► Парсинг диапазона портов (network.go::parsePortRange)
   │   │   └─► Генерация списка портов
   │   │
   │   ├─► Обнаружение активных хостов (scanner.go::isHostAlive)
   │   │   ├─► Параллельная проверка каждого IP
   │   │   └─► Проверка популярных портов (80, 443, 22, ...)
   │   │
   │   └─► Сканирование портов на активных хостах
   │       ├─► Для каждого активного хоста (scanner.go::scanHost)
   │       │   ├─► Получение MAC адреса (scanner.go::getMACAddress)
   │       │   │   └─► ARP запрос через pcap (scanner.go::getMACViaARPRequest)
   │       │   │
   │       │   ├─► Получение hostname (net.LookupAddr)
   │       │   │
   │       │   ├─► Сканирование портов (network.go::isPortOpen)
   │       │   │   └─► TCP connect для каждого порта
   │       │   │
   │       │   ├─► Определение протоколов (scanner.go::getProtocolFromPort)
   │       │   │
   │       │   └─► Определение типа устройства (scanner.go::detectDeviceType)
   │       │
   │       └─► Сохранение результатов в ScanResult
   │
   ├─► Получение результатов (scanner.go::GetResults)
   │
   ├─► Отображение результатов (display.go::displayResults)
   │   └─► Форматирование в таблицу
   │
   └─► Отображение аналитики (display.go::displayAnalytics)
       ├─► Статистика по протоколам
       ├─► Статистика по портам
       ├─► Статистика по типам устройств
       └─► Общая статистика
```

### Поток данных при сканировании хоста

```
IP адрес
   │
   ▼
┌─────────────────────┐
│  isHostAlive()      │
│  Проверка портов:   │
│  80, 443, 22, ...   │
└──────────┬──────────┘
           │
           ├─► Хост не отвечает ──► Пропуск
           │
           └─► Хост отвечает ──► Продолжение
                   │
                   ▼
           ┌─────────────────────┐
           │  scanHost()         │
           └──────────┬──────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
   ┌─────────┐  ┌──────────┐  ┌──────────┐
   │  MAC    │  │ Hostname │  │  Порты   │
   │  адрес  │  │          │  │          │
   └────┬────┘  └────┬─────┘  └────┬─────┘
        │            │             │
        └────────────┼─────────────┘
                     │
                     ▼
            ┌─────────────────┐
            │  ScanResult     │
            │  - IP           │
            │  - MAC          │
            │  - Hostname     │
            │  - Ports[]      │
            │  - Protocols[]  │
            │  - DeviceType   │
            │  - Vendor       │
            └─────────────────┘
```

---

## Параллелизм и синхронизация

### Модель параллелизма

Проект использует **worker pool pattern** с горутинами Go:

```
┌─────────────────────────────────────────┐
│         Main Goroutine                  │
│  (Управление и координация)             │
└──────────────┬──────────────────────────┘
               │
               ▼
    ┌──────────────────────┐
    │   Semaphore Channel   │
    │   (Ограничение        │
    │    параллелизма)      │
    └──────────┬────────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
    ▼          ▼          ▼
┌────────┐ ┌────────┐ ┌────────┐
│Worker 1│ │Worker 2│ │Worker N│
│Goroutine│ │Goroutine│ │Goroutine│
└────────┘ └────────┘ └────────┘
    │          │          │
    └──────────┼──────────┘
               │
               ▼
    ┌──────────────────────┐
    │   Results Collection  │
    │   (С синхронизацией)  │
    └──────────────────────┘
```

### Синхронизация

1. **Семафор для ограничения параллелизма:**
   ```go
   sem := make(chan struct{}, ns.threads)
   ```

2. **Мьютексы для защиты общих данных:**
   ```go
   var mu sync.RWMutex  // Для результатов
   var aliveMutex sync.Mutex  // Для списка активных хостов
   ```

3. **WaitGroup для ожидания завершения:**
   ```go
   var wg sync.WaitGroup
   ```

4. **Context для отмены операций:**
   ```go
   ctx, cancel := context.WithCancel(context.Background())
   ```

### Пример параллельного сканирования

```go
// Создание пула горутин
sem := make(chan struct{}, threads)

// Для каждого IP
for _, ip := range ips {
    sem <- struct{}{}  // Захват семафора
    wg.Add(1)
    
    go func(ip net.IP) {
        defer func() { <-sem }()  // Освобождение семафора
        defer wg.Done()
        
        // Работа с IP
        if isHostAlive(ip) {
            mu.Lock()
            aliveIPs = append(aliveIPs, ip)
            mu.Unlock()
        }
    }(ip)
}

wg.Wait()  // Ожидание завершения всех горутин
```

---

## Обработка ошибок

### Стратегия обработки ошибок

1. **Проверка на каждом этапе:**
   - Парсинг параметров
   - Определение сети
   - Подключения к хостам

2. **Graceful degradation:**
   - Если MAC адрес не получен - продолжаем без него
   - Если hostname не получен - используем IP
   - Если устройство не отвечает - пропускаем

3. **Логирование ошибок:**
   - Вывод в консоль для важных ошибок
   - Тихий пропуск для некритичных ошибок

### Примеры обработки ошибок

```go
// Определение сети
network, err := detectLocalNetwork()
if err != nil {
    log.Fatalf("Не удалось определить сеть: %v", err)
}

// Получение MAC (не критично)
mac, err := ns.getMACAddress(ip)
if err == nil {
    result.MAC = mac
}
// Продолжаем даже если MAC не получен

// Проверка порта
if isPortOpen(host, port, timeout) {
    // Порт открыт
} else {
    // Порт закрыт или недоступен - пропускаем
}
```

---

## Расширяемость

### Точки расширения

1. **Добавление новых методов обнаружения хостов:**
   ```go
   // В scanner.go можно добавить:
   func (ns *NetworkScanner) isHostAliveICMP(ip string) bool
   func (ns *NetworkScanner) isHostAliveARP(ip string) bool
   ```

2. **Расширение определения устройств:**
   ```go
   // В scanner.go можно улучшить:
   func (ns *NetworkScanner) detectDeviceType(result ScanResult) string {
       // Добавить больше правил
   }
   ```

3. **Добавление новых форматов экспорта:**
   ```go
   // Новый файл export.go:
   func exportToJSON(results []ScanResult) error
   func exportToCSV(results []ScanResult) error
   ```

4. **Добавление UDP сканирования:**
   ```go
   // В network.go:
   func isUDPPortOpen(host string, port int, timeout time.Duration) bool
   ```

### Интерфейсы для расширения

Можно создать интерфейсы для плагинов:

```go
type PortScanner interface {
    ScanPort(host string, port int) PortInfo
}

type DeviceDetector interface {
    DetectDevice(result ScanResult) DeviceInfo
}

type ResultExporter interface {
    Export(results []ScanResult) error
}
```

---

## Производительность и оптимизация

### Оптимизации

1. **Двухэтапное сканирование:**
   - Сначала быстрая проверка доступности
   - Затем детальное сканирование только активных

2. **Параллелизм:**
   - Настраиваемое количество потоков
   - Эффективное использование ресурсов

3. **Минимизация сетевых запросов:**
   - Проверка только необходимых портов
   - Настраиваемый таймаут

### Метрики производительности

- **Время проверки хоста:** ~100-300ms
- **Время сканирования порта:** ~50-200ms
- **Пропускная способность:** ~100-500 хостов/минуту (зависит от настроек)

---

## Безопасность архитектуры

### Защита от race conditions

- Использование мьютексов для общих данных
- Атомарные операции где возможно
- Правильное использование каналов

### Защита ресурсов

- Ограничение параллелизма через семафоры
- Таймауты для всех сетевых операций
- Graceful shutdown при прерывании

---

**Версия документа:** 1.0  
**Последнее обновление:** 2024

