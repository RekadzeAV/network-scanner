# Техническая документация - Network Scanner

## Содержание

1. [Обзор архитектуры](#обзор-архитектуры)
2. [Структура проекта](#структура-проекта)
3. [Основные компоненты](#основные-компоненты)
4. [Алгоритмы и методы](#алгоритмы-и-методы)
5. [Зависимости](#зависимости)
6. [Производительность](#производительность)
7. [Ограничения](#ограничения)
8. [Будущие улучшения](#будущие-улучшения)

---

## Обзор архитектуры

Network Scanner построен на языке Go и использует конкурентную модель с горутинами для параллельного сканирования сети.

### Основные принципы

- **Многопоточность:** Использует горутины Go для параллельного сканирования
- **Модульность:** Разделение на логические модули (сканирование, сеть, отображение)
- **Кроссплатформенность:** Работает на Windows, macOS, Linux
- **Расширяемость:** Легко добавлять новые функции

### Технологический стек

- **Язык:** Go 1.21+
- **Библиотеки:**
  - `github.com/google/gopacket` - работа с сетевыми пакетами (ARP)
  - `github.com/jedib0t/go-pretty/v6` - форматирование таблиц
  - Стандартная библиотека Go для сетевых операций

---

## Структура проекта

```
Сканер локальной сети/
├── main.go          # Точка входа, обработка параметров командной строки
├── scanner.go       # Основная логика сканирования
├── network.go       # Работа с сетью (определение сети, парсинг)
├── display.go       # Отображение результатов и аналитика
├── go.mod           # Зависимости проекта
├── build.sh         # Скрипт сборки для Unix
├── build-macos.sh   # Скрипт сборки для macOS
├── build.bat        # Скрипт сборки для Windows
├── README.md        # Основная документация
├── USER_GUIDE.md    # Руководство пользователя
├── TECHNICAL.md     # Техническая документация (этот файл)
├── ARCHITECTURE.md  # Архитектура проекта
└── INSTALL.md       # Инструкции по установке
```

---

## Основные компоненты

### 1. main.go - Точка входа

**Ответственность:**
- Парсинг параметров командной строки
- Инициализация сканера
- Обработка сигналов (Ctrl+C)
- Координация работы компонентов

**Ключевые функции:**
- `main()` - главная функция приложения

**Параметры командной строки:**
```go
- range: string      // Диапазон сети
- timeout: duration  // Таймаут подключения
- ports: string      // Диапазон портов
- threads: int       // Количество потоков
- show-closed: bool  // Показывать закрытые порты
```

### 2. scanner.go - Логика сканирования

**Ответственность:**
- Управление процессом сканирования
- Обнаружение активных хостов
- Сканирование портов
- Определение MAC адресов
- Определение типов устройств

**Основные типы:**

```go
// Результат сканирования одного хоста
type ScanResult struct {
    IP          string
    MAC         string
    Hostname    string
    Ports       []PortInfo
    Protocols   []string
    DeviceType  string
    DeviceVendor string
    IsAlive     bool
}

// Информация о порте
type PortInfo struct {
    Port     int
    State    string  // "open", "closed", "filtered"
    Protocol string  // "tcp", "udp"
    Service  string
}

// Сканер сети
type NetworkScanner struct {
    network   string
    timeout   time.Duration
    portRange string
    threads   int
    results   []ScanResult
    mu        sync.RWMutex
    ctx       context.Context
    cancel    context.CancelFunc
    wg        sync.WaitGroup
}
```

**Ключевые методы:**

- `NewNetworkScanner()` - создание нового сканера
- `Scan()` - запуск сканирования
- `isHostAlive()` - проверка доступности хоста
- `scanHost()` - сканирование одного хоста
- `getMACAddress()` - получение MAC адреса
- `detectDeviceType()` - определение типа устройства
- `Stop()` - остановка сканирования
- `GetResults()` - получение результатов

### 3. network.go - Работа с сетью

**Ответственность:**
- Автоматическое определение локальной сети
- Парсинг диапазонов сети (CIDR)
- Парсинг диапазонов портов
- Проверка открытости портов
- Определение сервисов по портам

**Ключевые функции:**

- `detectLocalNetwork()` - автоматическое определение сети
- `parseNetworkRange()` - парсинг CIDR нотации
- `parsePortRange()` - парсинг диапазона портов
- `isPortOpen()` - проверка открытости порта
- `getServiceName()` - определение сервиса по порту

### 4. display.go - Отображение результатов

**Ответственность:**
- Форматирование и вывод результатов
- Генерация аналитики
- Статистика по протоколам и портам

**Ключевые функции:**

- `displayResults()` - вывод таблицы результатов
- `displayAnalytics()` - вывод аналитики
- `formatPorts()` - форматирование списка портов
- `getProtocolDescription()` - описание протоколов
- `getPortPurpose()` - назначение портов

---

## Алгоритмы и методы

### Обнаружение активных хостов

**Алгоритм:**
1. Генерация списка IP адресов из диапазона сети
2. Параллельная проверка доступности каждого IP
3. Проверка популярных портов: 80, 443, 22, 135, 139, 445
4. Если хотя бы один порт отвечает - хост считается активным

**Реализация:**
```go
func (ns *NetworkScanner) isHostAlive(ip string) bool {
    commonPorts := []string{"80", "443", "22", "135", "139", "445"}
    for _, port := range commonPorts {
        conn, err := net.DialTimeout("tcp", net.JoinHostPort(ip, port), ns.timeout)
        if err == nil {
            conn.Close()
            return true
        }
    }
    return false
}
```

**Особенности:**
- Использует TCP connect вместо ICMP ping (работает через firewall)
- Проверяет несколько портов для надежности
- Учитывает контекст для возможности отмены

### Сканирование портов

**Алгоритм:**
1. Для каждого активного хоста
2. Параллельно проверяются все указанные порты
3. Используется TCP connect для проверки
4. Результаты сохраняются в структуре ScanResult

**Реализация:**
```go
func isPortOpen(host string, port int, timeout time.Duration) bool {
    address := fmt.Sprintf("%s:%d", host, port)
    conn, err := net.DialTimeout("tcp", address, timeout)
    if err != nil {
        return false
    }
    defer conn.Close()
    return true
}
```

**Особенности:**
- Простое TCP connect сканирование
- Поддержка настраиваемого таймаута
- Только TCP порты (UDP не поддерживается)

### Получение MAC адресов

**Алгоритм:**
1. Попытка прочитать из системной ARP таблицы (не реализовано)
2. Отправка ARP запроса через pcap
3. Ожидание ARP ответа
4. Извлечение MAC адреса из ответа

**Реализация:**
- Использует библиотеку `gopacket` для работы с ARP
- Требует права администратора на некоторых системах
- Работает только для устройств в той же подсети

**Ограничения:**
- Может не работать без прав администратора
- Медленнее чем TCP connect
- Не работает для устройств в других подсетях

### Определение типа устройства

**Алгоритм:**
Анализ открытых портов и протоколов:

```go
// Роутер/сетевое оборудование: порты 80/443/8080 + 22
// Веб-сервер: порты 80/443/8080/8443
// База данных: порты 3306/5432/1433
// Windows: порты 3389/445
// Linux/Unix: порт 22
// Принтер: порты 9100/515
// IoT: мало портов (< 3)
```

**Особенности:**
- Эвристический подход
- Может быть неточным для нестандартных конфигураций
- Можно улучшить добавлением базы данных устройств

---

## Зависимости

### Основные зависимости

```go
require (
    github.com/jedib0t/go-pretty/v6 v6.5.4  // Таблицы
    github.com/google/gopacket v1.1.19       // Сетевые пакеты
)
```

### Косвенные зависимости

```go
require (
    github.com/mattn/go-runewidth v0.0.15    // Ширина символов
    github.com/rivo/uniseg v0.4.4            // Unicode сегментация
    golang.org/x/net v0.19.0                 // Сетевые утилиты
    golang.org/x/sys v0.15.0                 // Системные вызовы
)
```

### Системные требования

- **Go:** 1.21 или выше
- **Права:** Для MAC адресов может потребоваться root/sudo
- **Сеть:** Локальная сеть для сканирования

---

## Производительность

### Оптимизации

1. **Параллельное сканирование:**
   - Использует горутины для параллельной работы
   - Настраиваемое количество потоков (по умолчанию 100)

2. **Двухэтапное сканирование:**
   - Сначала проверка доступности хостов
   - Затем сканирование портов только на активных хостах

3. **Эффективное использование памяти:**
   - Результаты сохраняются только для активных хостов
   - Использование указателей и слайсов

### Производительность

**Типичные показатели:**
- Проверка хоста: ~100-300ms (зависит от таймаута)
- Сканирование порта: ~50-200ms
- Сканирование сети /24 (254 хоста, 1000 портов): ~5-15 минут

**Факторы влияния:**
- Размер сети
- Количество портов
- Таймаут подключения
- Количество потоков
- Скорость сети

### Рекомендации по производительности

1. **Для быстрого сканирования:**
   ```bash
   -ports 80,443,22 -timeout 1s -threads 200
   ```

2. **Для точного сканирования:**
   ```bash
   -ports 1-1000 -timeout 5s -threads 100
   ```

3. **Для полного сканирования:**
   ```bash
   -ports 1-65535 -timeout 3s -threads 50
   ```

---

## Ограничения

### Технические ограничения

1. **Только TCP порты:**
   - UDP сканирование не поддерживается
   - Причина: UDP требует другого подхода

2. **MAC адреса:**
   - Могут не определяться без прав администратора
   - Работают только в той же подсети
   - Требуют библиотеку pcap

3. **Обнаружение хостов:**
   - Использует TCP connect, не ICMP ping
   - Может пропустить устройства без открытых портов
   - Зависит от firewall настроек

4. **Определение устройств:**
   - Эвристический подход, может быть неточным
   - Ограниченная база производителей по MAC

### Функциональные ограничения

1. **Нет сохранения результатов:**
   - Результаты только выводятся в консоль
   - Нет экспорта в файлы (JSON, CSV)

2. **Нет фильтрации:**
   - Нет фильтров по типу устройства
   - Нет фильтров по протоколам

3. **Нет планировщика:**
   - Нет автоматического периодического сканирования
   - Нет сравнения результатов

---

## Будущие улучшения

### Краткосрочные (легко реализуемые)

1. **Экспорт результатов:**
   - JSON формат
   - CSV формат
   - XML формат

2. **Улучшенная фильтрация:**
   - Фильтр по типу устройства
   - Фильтр по протоколам
   - Фильтр по портам

3. **Чтение ARP таблицы:**
   - Реализация для Linux (/proc/net/arp)
   - Реализация для macOS (arp -a)
   - Реализация для Windows

### Среднесрочные (требуют больше работы)

1. **UDP сканирование:**
   - Поддержка UDP портов
   - Определение UDP сервисов

2. **Улучшенное определение устройств:**
   - База данных устройств
   - Fingerprinting по ответам
   - Определение версий сервисов

3. **Веб-интерфейс:**
   - REST API
   - Веб-интерфейс для просмотра результатов
   - История сканирований

### Долгосрочные (большие изменения)

1. **Распределенное сканирование:**
   - Сканирование с нескольких точек
   - Координация результатов

2. **Анализ безопасности:**
   - Обнаружение уязвимостей
   - Рекомендации по безопасности
   - Отчеты о безопасности

3. **Интеграции:**
   - Интеграция с системами мониторинга
   - Уведомления об изменениях
   - API для внешних систем

---

## Безопасность

### Соображения безопасности

1. **Сетевые запросы:**
   - Может быть обнаружено системами IDS/IPS
   - Может вызвать подозрения в корпоративных сетях

2. **Права доступа:**
   - Требует прав администратора для MAC адресов
   - Может требовать специальных разрешений

3. **Этичное использование:**
   - Используйте только в своих сетях
   - Получайте разрешение перед сканированием
   - Соблюдайте политики безопасности

### Рекомендации

- Используйте только в тестовых/собственных сетях
- Получайте письменное разрешение перед сканированием корпоративных сетей
- Информируйте администраторов сети о сканировании
- Соблюдайте законы и политики безопасности

---

**Версия документа:** 1.0  
**Последнее обновление:** 2024

