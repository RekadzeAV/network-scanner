#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞

set -e

echo "=========================================="
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ Network Scanner"
echo "=========================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Go
if ! command -v go &> /dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: Go –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo ""
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Go –æ–¥–Ω–∏–º –∏–∑ —Å–ø–æ—Å–æ–±–æ–≤:"
    echo "1. –ß–µ—Ä–µ–∑ Homebrew: brew install go"
    echo "2. –°–∫–∞—á–∞–π—Ç–µ —Å https://go.dev/dl/"
    echo ""
    exit 1
fi

echo "‚úÖ Go –Ω–∞–π–¥–µ–Ω: $(go version)"
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")/.."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞..."
if [ ! -d "cmd/network-scanner" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: cmd/network-scanner –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

if [ ! -d "internal/scanner" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: internal/scanner –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

if [ ! -d "internal/network" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: internal/network –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

if [ ! -d "internal/display" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: internal/display –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
go mod download
go mod tidy
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
if ! go build ./...; then
    echo "‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏!"
    exit 1
fi
echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞ (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
if command -v golangci-lint &> /dev/null; then
    echo "üîç –ó–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–∞..."
    golangci-lint run ./... || echo "‚ö†Ô∏è  –õ–∏–Ω—Ç–µ—Ä –Ω–∞—à–µ–ª –ø—Ä–æ–±–ª–µ–º—ã (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"
    echo ""
fi

# –ü–æ–ø—ã—Ç–∫–∞ —Å–±–æ—Ä–∫–∏
echo "üî® –ü–æ–ø—ã—Ç–∫–∞ —Å–±–æ—Ä–∫–∏..."
mkdir -p release
if go build -o release/network-scanner-test ./cmd/network-scanner; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!"
    echo ""
    echo "–ë–∏–Ω–∞—Ä–Ω–∏–∫ —Å–æ–∑–¥–∞–Ω: release/network-scanner-test"
    echo ""
    echo "–î–ª—è –∑–∞–ø—É—Å–∫–∞:"
    echo "  ./release/network-scanner-test"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏!"
    exit 1
fi

echo "=========================================="
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "=========================================="




